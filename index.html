<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fest Entry Pass Registration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .entry-pass {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border: 3px solid #fbbf24;
        }
        .success-animation {
            animation: scaleIn 0.3s ease-out;
        }
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: #10b981;
            color: white;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        #reader {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        #reader video {
            border-radius: 8px;
        }
        @media print {
            body * { visibility: hidden; }
            .entry-pass, .entry-pass * { visibility: visible; }
            .entry-pass { position: absolute; top: 0; left: 0; width: 100%; page-break-after: avoid; }
            .no-print { display: none !important; }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="gradient-bg h-full">
  <div class="h-full w-full overflow-auto">
   <div class="container mx-auto px-4 py-8"><!-- Header -->
    <div class="text-center mb-8">
     <h1 id="festTitle" class="text-4xl font-bold text-white mb-2">üéâ College Fest 2024</h1>
     <p class="text-xl text-white opacity-90">Entry Pass Registration &amp; Management</p>
    </div><!-- Tab Navigation -->
    <div class="max-w-6xl mx-auto mb-6">
     <div class="bg-white rounded-xl p-2 card-shadow flex gap-2"><button id="tabRegister" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-all bg-blue-600 text-white"> Register New Entry </button> <button id="tabView" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-all text-gray-600 hover:bg-gray-100"> Admin Panel </button>
     </div>
    </div><!-- Registration Section -->
    <div id="registrationSection" class="max-w-6xl mx-auto">
     <div class="grid md:grid-cols-2 gap-8"><!-- Payment QR Code -->
      <div class="bg-white rounded-xl p-8 card-shadow">
       <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Step 1: Make Payment</h2>
       <div class="text-center">
        <div class="bg-gray-100 p-6 rounded-lg mb-4">
         <canvas id="paymentQR" class="mx-auto"></canvas>
         <img src="C:\Users\dheru\OneDrive\Desktop\entry pass\qr.jpg"
            style="width:500px;"
            >   
        </div>
        <div class="bg-blue-50 p-4 rounded-lg">
         <p id="feeDisplay" class="text-lg font-semibold text-blue-800">Entry Fee: ‚Çπ200</p>
         <p class="text-sm text-blue-600 mt-2">Scan QR code with any UPI app</p>
         <p id="upiDisplay" class="text-xs text-gray-600 mt-1">UPI: festpayments@upi</p>
        </div>
       </div>
      </div><!-- Registration Form -->
      <div class="bg-white rounded-xl p-8 card-shadow">
       <h2 class="text-2xl font-bold text-gray-800 mb-6">Step 2: Complete Registration</h2>
       <form id="registrationForm" class="space-y-4">
        <div><label for="studentName" class="block text-sm font-medium text-gray-700 mb-2">Student Name *</label> <input type="text" id="studentName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label for="rollNo" class="block text-sm font-medium text-gray-700 mb-2">Roll Number *</label> <input type="text" id="rollNo" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="section" class="block text-sm font-medium text-gray-700 mb-2">Section *</label> <select id="section" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Select Section</option> <option value="A">A</option> <option value="B">B</option> <option value="C">C</option> <option value="D">D</option> </select>
         </div>
         <div><label for="year" class="block text-sm font-medium text-gray-700 mb-2">Year *</label> <select id="year" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Select Year</option> <option value="1st Year">1st Year</option> <option value="2nd Year">2nd Year</option> <option value="3rd Year">3rd Year</option> <option value="4th Year">4th Year</option> </select>
         </div>
        </div>
        <div><label for="department" class="block text-sm font-medium text-gray-700 mb-2">Department *</label> <input type="text" id="department" required placeholder="e.g., Computer Science" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number *</label> <input type="tel" id="phone" required pattern="[0-9]{10}" placeholder="10-digit mobile number" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email *</label> <input type="email" id="email" required placeholder="your.email@example.com" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label for="paymentId" class="block text-sm font-medium text-gray-700 mb-2">UPI Transaction ID *</label> <input type="text" id="paymentId" required placeholder="Enter 12-digit transaction ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label for="paymentScreenshot" class="block text-sm font-medium text-gray-700 mb-2">Payment Screenshot * (Max 20MB)</label> <input type="file" id="paymentScreenshot" required accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
         <p class="text-xs text-gray-500 mt-1">Upload screenshot of payment confirmation</p>
        </div><button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all shadow-lg"> Generate Entry Pass </button>
       </form>
      </div>
     </div>
    </div><!-- Admin Login Section -->
    <div id="adminLoginSection" class="max-w-md mx-auto hidden">
     <div class="bg-white rounded-xl p-8 card-shadow">
      <div class="text-center mb-6">
       <div class="text-6xl mb-4">
        üîí
       </div>
       <h2 class="text-2xl font-bold text-gray-800">Admin Access</h2>
       <p class="text-gray-600 mt-2">Enter credentials to view registrations</p>
      </div>
      <form id="adminLoginForm" class="space-y-4">
       <div><label for="adminUsernameInput" class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="adminUsernameInput" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       </div>
       <div><label for="adminPasswordInput" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="adminPasswordInput" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       </div><button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all"> Login </button>
      </form>
     </div>
    </div><!-- View Registrations Section -->
    <div id="viewSection" class="max-w-6xl mx-auto hidden">
     <div class="bg-white rounded-xl p-8 card-shadow mb-6">
      <div class="flex justify-between items-center mb-6">
       <div>
        <h2 class="text-2xl font-bold text-gray-800">Admin Dashboard</h2>
        <p id="totalCount" class="text-gray-600 mt-1">Total: 0 registrations</p>
       </div>
       <div class="flex gap-3"><button id="scannerBtn" class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-all"> üì∑ Scan QR Code </button> <button id="logoutBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-all"> Logout </button>
       </div>
      </div>
      <div class="mb-4"><input type="text" id="searchInput" placeholder="Search by name or roll no..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>
      <div id="registrationsList" class="space-y-4 max-h-96 overflow-y-auto"><!-- Registration cards will be inserted here -->
      </div>
      <div id="emptyState" class="text-center py-12 hidden">
       <div class="text-6xl mb-4">
        üìã
       </div>
       <p class="text-gray-500 text-lg">No registrations yet.</p>
      </div>
     </div>
    </div><!-- QR Scanner Modal -->
    <div id="scannerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
     <div class="bg-white rounded-xl p-8 max-w-2xl w-full card-shadow">
      <div class="text-center mb-6">
       <h2 class="text-2xl font-bold text-gray-800 mb-2">Scan Entry Pass QR Code</h2>
       <p class="text-gray-600">Point camera at student's QR code</p>
      </div>
      <div id="reader" class="mb-6"></div>
      <div id="scanResult" class="hidden mb-6"><!-- Scan result will be shown here -->
      </div><button id="closeScannerBtn" class="w-full bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 transition-all"> Close Scanner </button>
     </div>
    </div><!-- Entry Pass Modal -->
    <div id="passModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
     <div class="bg-white rounded-xl p-8 max-w-2xl w-full card-shadow success-animation">
      <div class="text-center mb-6">
       <div class="text-6xl mb-4">
        ‚úÖ
       </div>
       <h2 class="text-3xl font-bold text-green-600 mb-2">Registration Successful!</h2>
       <p class="text-gray-600">Your entry pass has been generated. Save this QR code!</p>
      </div>
      <div id="entryPassContent" class="entry-pass rounded-xl p-8 text-white mb-6"><!-- Entry pass content will be inserted here -->
      </div>
      <div class="flex gap-4 no-print"><button id="downloadQRBtn" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-all"> üíæ Download QR Code </button> <button id="printPassBtn" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all"> üñ®Ô∏è Print Pass </button> <button id="closeModalBtn" class="flex-1 bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 transition-all"> Close </button>
      </div>
     </div>
    </div><!-- Registration Detail Modal -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
     <div class="bg-white rounded-xl p-8 max-w-4xl w-full card-shadow overflow-y-auto" style="max-height: 90%;">
      <div id="detailContent"><!-- Detail content will be inserted here -->
      </div><button id="closeDetailBtn" class="w-full mt-6 bg-gray-600 text-white py-3 rounded-lg font-semibold hover:bg-gray-700 transition-all"> Close </button>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Default configuration
        const defaultConfig = {
            fest_name: "College Fest 2024",
            entry_fee: "‚Çπ200",
            upi_id: "festpayments@upi",
            admin_username: "admin",
            admin_password: "admin123",
            primary_color: "#667eea",
            secondary_color: "#764ba2",
            accent_color: "#fbbf24",
            text_color: "#1f2937",
            button_color: "#3b82f6",
            font_family: "system-ui",
            font_size: 16
        };

        let allRegistrations = [];
        let currentRecordCount = 0;
        let isAdminLoggedIn = false;
        let html5QrCode = null;
        let currentPassData = null;

        // Data handler for SDK
        const dataHandler = {
            onDataChanged(data) {
                allRegistrations = data;
                currentRecordCount = data.length;
                if (isAdminLoggedIn) {
                    updateRegistrationsList();
                    updateTotalCount();
                    checkEmptyState();
                }
            }
        };

        // Initialize Data SDK
        async function initializeDataSdk() {
            if (window.dataSdk) {
                const result = await window.dataSdk.init(dataHandler);
                if (!result.isOk) {
                    console.error("Failed to initialize data SDK");
                }
            }
        }

        // Config change handler
        async function onConfigChange(config) {
            const festName = config.fest_name || defaultConfig.fest_name;
            const entryFee = config.entry_fee || defaultConfig.entry_fee;
            const upiId = config.upi_id || defaultConfig.upi_id;
            const customFont = config.font_family || defaultConfig.font_family;
            const baseSize = config.font_size || defaultConfig.font_size;
            const baseFontStack = 'system-ui, -apple-system, sans-serif';

            document.getElementById('festTitle').textContent = `üéâ ${festName}`;
            document.getElementById('festTitle').style.fontFamily = `${customFont}, ${baseFontStack}`;
            document.getElementById('festTitle').style.fontSize = `${baseSize * 2}px`;
            
            document.getElementById('feeDisplay').textContent = `Entry Fee: ${entryFee}`;
            document.getElementById('upiDisplay').textContent = `UPI: ${upiId}`;

            generatePaymentQR(upiId, entryFee);

            document.body.style.background = `linear-gradient(135deg, ${config.primary_color || defaultConfig.primary_color} 0%, ${config.secondary_color || defaultConfig.secondary_color} 100%)`;
        }

        // Initialize Element SDK
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities: (config) => ({
                    recolorables: [
                        {
                            get: () => config.primary_color || defaultConfig.primary_color,
                            set: (value) => {
                                config.primary_color = value;
                                window.elementSdk.setConfig({ primary_color: value });
                            }
                        },
                        {
                            get: () => config.secondary_color || defaultConfig.secondary_color,
                            set: (value) => {
                                config.secondary_color = value;
                                window.elementSdk.setConfig({ secondary_color: value });
                            }
                        },
                        {
                            get: () => config.accent_color || defaultConfig.accent_color,
                            set: (value) => {
                                config.accent_color = value;
                                window.elementSdk.setConfig({ accent_color: value });
                            }
                        },
                        {
                            get: () => config.text_color || defaultConfig.text_color,
                            set: (value) => {
                                config.text_color = value;
                                window.elementSdk.setConfig({ text_color: value });
                            }
                        },
                        {
                            get: () => config.button_color || defaultConfig.button_color,
                            set: (value) => {
                                config.button_color = value;
                                window.elementSdk.setConfig({ button_color: value });
                            }
                        }
                    ],
                    borderables: [],
                    fontEditable: {
                        get: () => config.font_family || defaultConfig.font_family,
                        set: (value) => {
                            config.font_family = value;
                            window.elementSdk.setConfig({ font_family: value });
                        }
                    },
                    fontSizeable: {
                        get: () => config.font_size || defaultConfig.font_size,
                        set: (value) => {
                            config.font_size = value;
                            window.elementSdk.setConfig({ font_size: value });
                        }
                    }
                }),
                mapToEditPanelValues: (config) => new Map([
                    ["fest_name", config.fest_name || defaultConfig.fest_name],
                    ["entry_fee", config.entry_fee || defaultConfig.entry_fee],
                    ["upi_id", config.upi_id || defaultConfig.upi_id],
                    ["admin_username", config.admin_username || defaultConfig.admin_username],
                    ["admin_password", config.admin_password || defaultConfig.admin_password]
                ])
            });
        }

        // Generate payment QR code
        function generatePaymentQR(upiId, amount) {
            const canvas = document.getElementById('paymentQR');
            const amountNumber = amount.replace(/[^0-9]/g, '');
            const upiString = `upi://pay?pa=${upiId}&am=${amountNumber}&cu=INR`;
            
            QRCode.toCanvas(canvas, upiString, {
                width: 200,
                margin: 2,
                color: {
                    dark: '#000000',
                    light: '#ffffff'
                }
            });
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'success' ? '#10b981' : '#ef4444';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Tab switching
        document.getElementById('tabRegister').addEventListener('click', () => {
            document.getElementById('registrationSection').classList.remove('hidden');
            document.getElementById('adminLoginSection').classList.add('hidden');
            document.getElementById('viewSection').classList.add('hidden');
            document.getElementById('tabRegister').classList.add('bg-blue-600', 'text-white');
            document.getElementById('tabRegister').classList.remove('text-gray-600', 'hover:bg-gray-100');
            document.getElementById('tabView').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('tabView').classList.add('text-gray-600', 'hover:bg-gray-100');
        });

        document.getElementById('tabView').addEventListener('click', () => {
            document.getElementById('registrationSection').classList.add('hidden');
            
            if (isAdminLoggedIn) {
                document.getElementById('adminLoginSection').classList.add('hidden');
                document.getElementById('viewSection').classList.remove('hidden');
            } else {
                document.getElementById('adminLoginSection').classList.remove('hidden');
                document.getElementById('viewSection').classList.add('hidden');
            }
            
            document.getElementById('tabView').classList.add('bg-blue-600', 'text-white');
            document.getElementById('tabView').classList.remove('text-gray-600', 'hover:bg-gray-100');
            document.getElementById('tabRegister').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('tabRegister').classList.add('text-gray-600', 'hover:bg-gray-100');
        });

        // Admin login
        document.getElementById('adminLoginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            const username = document.getElementById('adminUsernameInput').value;
            const password = document.getElementById('adminPasswordInput').value;
            const adminUsername = config.admin_username || defaultConfig.admin_username;
            const adminPassword = config.admin_password || defaultConfig.admin_password;

            if (username === adminUsername && password === adminPassword) {
                isAdminLoggedIn = true;
                document.getElementById('adminLoginSection').classList.add('hidden');
                document.getElementById('viewSection').classList.remove('hidden');
                updateRegistrationsList();
                updateTotalCount();
                checkEmptyState();
                showToast('Login successful!');
                document.getElementById('adminLoginForm').reset();
            } else {
                showToast('Invalid credentials!', 'error');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            isAdminLoggedIn = false;
            document.getElementById('viewSection').classList.add('hidden');
            document.getElementById('adminLoginSection').classList.remove('hidden');
            showToast('Logged out successfully');
        });

        // Form submission
        document.getElementById('registrationForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (currentRecordCount >= 1500) {
                showToast('Maximum limit of 1500 registrations reached!', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Validating...';

            const transactionId = document.getElementById('paymentId').value.trim();

            // Check if transaction ID already exists
            const existingTransaction = allRegistrations.find(reg => 
                reg.payment_id.toLowerCase() === transactionId.toLowerCase()
            );

            if (existingTransaction) {
                showToast('This transaction ID has already been registered!', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Entry Pass';
                
                const paymentField = document.getElementById('paymentId');
                paymentField.classList.add('border-red-500', 'border-2');
                setTimeout(() => {
                    paymentField.classList.remove('border-red-500', 'border-2');
                }, 3000);
                
                return;
            }

            // Handle screenshot upload
            const screenshotFile = document.getElementById('paymentScreenshot').files[0];
            if (!screenshotFile) {
                showToast('Please upload payment screenshot!', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Entry Pass';
                return;
            }

            // Check file size (20MB = 20 * 1024 * 1024 bytes)
            if (screenshotFile.size > 20 * 1024 * 1024) {
                showToast('Screenshot size must be less than 20MB!', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Entry Pass';
                return;
            }

            submitBtn.textContent = 'Processing screenshot...';

            // Convert screenshot to base64
            const reader = new FileReader();
            reader.onload = async function(event) {
                const screenshotBase64 = event.target.result;

                submitBtn.textContent = 'Creating registration...';

                const qrData = 'FEST-' + Date.now() + '-' + Math.random().toString(36).substring(7);
                
                const formData = {
                    id: 'REG' + Date.now(),
                    student_name: document.getElementById('studentName').value,
                    roll_no: document.getElementById('rollNo').value,
                    section: document.getElementById('section').value,
                    department: document.getElementById('department').value,
                    year: document.getElementById('year').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    payment_id: transactionId,
                    payment_screenshot: screenshotBase64,
                    registration_date: new Date().toISOString(),
                    qr_data: qrData,
                    verified: true,
                    entry_scanned: false,
                    scan_timestamp: ""
                };

                const result = await window.dataSdk.create(formData);

                if (result.isOk) {
                    showEntryPass(formData);
                    document.getElementById('registrationForm').reset();
                    showToast('Registration successful!');
                } else {
                    showToast('Registration failed. Please try again.', 'error');
                }

                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Entry Pass';
            };

            reader.onerror = function() {
                showToast('Failed to read screenshot!', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Generate Entry Pass';
            };

            reader.readAsDataURL(screenshotFile);
        });

        // Show entry pass modal
        function showEntryPass(data) {
            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            const passContent = document.getElementById('entryPassContent');
            
            currentPassData = data;
            
            const canvas = document.createElement('canvas');
            QRCode.toCanvas(canvas, data.qr_data, {
                width: 150,
                margin: 1,
                color: { dark: '#000000', light: '#ffffff' }
            });

            passContent.innerHTML = `
                <div class="text-center mb-4">
                    <h3 class="text-3xl font-bold mb-2">${config.fest_name || defaultConfig.fest_name}</h3>
                    <p class="text-xl opacity-90">ENTRY PASS</p>
                </div>
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <p class="text-sm opacity-75 mb-1">Name</p>
                        <p class="text-lg font-semibold">${data.student_name}</p>
                    </div>
                    <div>
                        <p class="text-sm opacity-75 mb-1">Roll No.</p>
                        <p class="text-lg font-semibold">${data.roll_no}</p>
                    </div>
                    <div>
                        <p class="text-sm opacity-75 mb-1">Department</p>
                        <p class="text-lg font-semibold">${data.department}</p>
                    </div>
                    <div>
                        <p class="text-sm opacity-75 mb-1">Year / Section</p>
                        <p class="text-lg font-semibold">${data.year} - ${data.section}</p>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm opacity-75 mb-1">Pass ID</p>
                        <p class="text-lg font-bold">${data.id}</p>
                    </div>
                    <div class="bg-white p-3 rounded-lg">
                        ${canvas.outerHTML}
                    </div>
                </div>
                <div class="mt-6 text-center text-sm opacity-90">
                    <p>üì± Save this QR code for entry at the venue</p>
                </div>
            `;

            document.getElementById('passModal').classList.remove('hidden');
        }

        // Close modal
        document.getElementById('closeModalBtn').addEventListener('click', () => {
            document.getElementById('passModal').classList.add('hidden');
            currentPassData = null;
        });

        // Download QR Code
        document.getElementById('downloadQRBtn').addEventListener('click', () => {
            if (!currentPassData) return;
            
            const canvas = document.createElement('canvas');
            QRCode.toCanvas(canvas, currentPassData.qr_data, {
                width: 500,
                margin: 2,
                color: { dark: '#000000', light: '#ffffff' }
            }, (error) => {
                if (!error) {
                    const link = document.createElement('a');
                    link.download = `entry-pass-${currentPassData.id}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                    showToast('QR code downloaded!');
                }
            });
        });

        // Print pass
        document.getElementById('printPassBtn').addEventListener('click', () => {
            window.print();
        });

        // Scanner functionality
        document.getElementById('scannerBtn').addEventListener('click', () => {
            document.getElementById('scannerModal').classList.remove('hidden');
            document.getElementById('scanResult').classList.add('hidden');
            startScanner();
        });

        document.getElementById('closeScannerBtn').addEventListener('click', () => {
            stopScanner();
            document.getElementById('scannerModal').classList.add('hidden');
        });

        function startScanner() {
            html5QrCode = new Html5Qrcode("reader");
            
            html5QrCode.start(
                { facingMode: "environment" },
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                onScanSuccess,
                onScanError
            ).catch(err => {
                showToast('Camera access denied or not available', 'error');
            });
        }

        function stopScanner() {
            if (html5QrCode) {
                html5QrCode.stop().catch(err => console.error(err));
            }
        }

        async function onScanSuccess(decodedText) {
            stopScanner();
            
            const registration = allRegistrations.find(reg => reg.qr_data === decodedText);
            const resultDiv = document.getElementById('scanResult');
            
            if (!registration) {
                resultDiv.innerHTML = `
                    <div class="bg-red-100 border-2 border-red-500 rounded-lg p-6 text-center">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <h3 class="text-2xl font-bold text-red-800 mb-2">Invalid QR Code</h3>
                        <p class="text-red-600">This QR code is not registered for this event.</p>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
                return;
            }

            if (registration.entry_scanned) {
                resultDiv.innerHTML = `
                    <div class="bg-red-100 border-2 border-red-500 rounded-lg p-6 text-center">
                        <div class="text-6xl mb-4">üö´</div>
                        <h3 class="text-2xl font-bold text-red-800 mb-2">ENTRY DENIED</h3>
                        <p class="text-red-600 text-lg mb-4">This entry pass has already been used!</p>
                        <div class="bg-white rounded-lg p-4 mt-4">
                            <p class="text-sm text-gray-700"><strong>Student:</strong> ${registration.student_name}</p>
                            <p class="text-sm text-gray-700"><strong>Previous Entry:</strong> ${new Date(registration.scan_timestamp).toLocaleString()}</p>
                        </div>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
                return;
            }

            // Mark as scanned
            const updatedReg = { ...registration, entry_scanned: true, scan_timestamp: new Date().toISOString() };
            const result = await window.dataSdk.update(updatedReg);

            if (result.isOk) {
                resultDiv.innerHTML = `
                    <div class="bg-green-100 border-2 border-green-500 rounded-lg p-6 text-center">
                        <div class="text-6xl mb-4">‚úÖ</div>
                        <h3 class="text-2xl font-bold text-green-800 mb-2">ENTRY GRANTED</h3>
                        <p class="text-green-600 text-lg mb-4">Welcome to the fest!</p>
                        <div class="bg-white rounded-lg p-4 mt-4 text-left">
                            <p class="text-sm text-gray-700 mb-2"><strong>Name:</strong> ${registration.student_name}</p>
                            <p class="text-sm text-gray-700 mb-2"><strong>Roll No:</strong> ${registration.roll_no}</p>
                            <p class="text-sm text-gray-700 mb-2"><strong>Department:</strong> ${registration.department}</p>
                            <p class="text-sm text-gray-700"><strong>Year:</strong> ${registration.year} - Section ${registration.section}</p>
                        </div>
                    </div>
                `;
                showToast('Entry granted successfully!');
            } else {
                resultDiv.innerHTML = `
                    <div class="bg-yellow-100 border-2 border-yellow-500 rounded-lg p-6 text-center">
                        <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                        <h3 class="text-2xl font-bold text-yellow-800 mb-2">Update Failed</h3>
                        <p class="text-yellow-600">Could not mark entry. Please try again.</p>
                    </div>
                `;
            }
            
            resultDiv.classList.remove('hidden');
        }

        function onScanError(error) {
            // Ignore scan errors (scanning in progress)
        }

        // Update registrations list
        function updateRegistrationsList() {
            const list = document.getElementById('registrationsList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            const filtered = allRegistrations.filter(reg => 
                reg.student_name.toLowerCase().includes(searchTerm) ||
                reg.roll_no.toLowerCase().includes(searchTerm)
            );

            list.innerHTML = filtered.map(reg => {
                const statusBadge = reg.entry_scanned 
                    ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">‚úì Entered</span>'
                    : '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Pending Entry</span>';
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="text-lg font-bold text-gray-800">${reg.student_name}</h3>
                                    ${statusBadge}
                                </div>
                                <p class="text-gray-600 mt-1">Roll No: ${reg.roll_no} | Section: ${reg.section}</p>
                                <p class="text-gray-600">${reg.department} - ${reg.year}</p>
                                <p class="text-sm text-gray-500 mt-2">üì± ${reg.phone} | ‚úâÔ∏è ${reg.email}</p>
                                <p class="text-sm text-gray-500">Payment ID: ${reg.payment_id}</p>
                                ${reg.entry_scanned ? `<p class="text-xs text-green-600 mt-1">Entered at: ${new Date(reg.scan_timestamp).toLocaleString()}</p>` : ''}
                            </div>
                            <div class="text-right">
                                <span class="inline-block bg-purple-100 text-purple-800 text-xs px-3 py-1 rounded-full font-semibold">
                                    ${reg.id}
                                </span>
                                <p class="text-xs text-gray-500 mt-2">${new Date(reg.registration_date).toLocaleDateString()}</p>
                                <button onclick="viewDetails('${reg.id}')" class="mt-2 text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                    View Details ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // View registration details
        window.viewDetails = function(id) {
            const registration = allRegistrations.find(reg => reg.id === id);
            if (!registration) return;

            const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
            const detailContent = document.getElementById('detailContent');
            
            const canvas = document.createElement('canvas');
            QRCode.toCanvas(canvas, registration.qr_data, {
                width: 200,
                margin: 1,
                color: { dark: '#000000', light: '#ffffff' }
            });

            detailContent.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Registration Details</h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Student Information</h3>
                        <div class="space-y-3">
                            <div>
                                <p class="text-sm text-gray-500">Full Name</p>
                                <p class="text-base font-semibold">${registration.student_name}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Roll Number</p>
                                <p class="text-base font-semibold">${registration.roll_no}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Department</p>
                                <p class="text-base font-semibold">${registration.department}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Year & Section</p>
                                <p class="text-base font-semibold">${registration.year} - Section ${registration.section}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Phone</p>
                                <p class="text-base font-semibold">${registration.phone}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Email</p>
                                <p class="text-base font-semibold">${registration.email}</p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Payment Information</h3>
                        <div class="space-y-3 mb-4">
                            <div>
                                <p class="text-sm text-gray-500">Transaction ID</p>
                                <p class="text-base font-semibold">${registration.payment_id}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Registration Date</p>
                                <p class="text-base font-semibold">${new Date(registration.registration_date).toLocaleString()}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Entry Status</p>
                                <p class="text-base font-semibold ${registration.entry_scanned ? 'text-green-600' : 'text-blue-600'}">
                                    ${registration.entry_scanned ? '‚úì Entry Scanned' : 'Pending Entry'}
                                </p>
                            </div>
                            ${registration.entry_scanned ? `
                                <div>
                                    <p class="text-sm text-gray-500">Entry Time</p>
                                    <p class="text-base font-semibold">${new Date(registration.scan_timestamp).toLocaleString()}</p>
                                </div>
                            ` : ''}
                        </div>

                        <div class="bg-gray-100 p-4 rounded-lg text-center">
                            <p class="text-sm text-gray-600 mb-2">Entry Pass QR Code</p>
                            ${canvas.outerHTML}
                            <p class="text-xs text-gray-500 mt-2">Pass ID: ${registration.id}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Payment Screenshot</h3>
                    <div class="bg-gray-100 rounded-lg p-4">
                        <img src="${registration.payment_screenshot}" alt="Payment Screenshot" class="max-w-full h-auto rounded-lg shadow-md mx-auto" style="max-height: 400px;">
                    </div>
                </div>
            `;

            document.getElementById('detailModal').classList.remove('hidden');
        };

        document.getElementById('closeDetailBtn').addEventListener('click', () => {
            document.getElementById('detailModal').classList.add('hidden');
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', updateRegistrationsList);

        // Update total count
        function updateTotalCount() {
            const scannedCount = allRegistrations.filter(r => r.entry_scanned).length;
            document.getElementById('totalCount').textContent = `Total: ${currentRecordCount} registrations | ${scannedCount} entered`;
        }

        // Check empty state
        function checkEmptyState() {
            const emptyState = document.getElementById('emptyState');
            const list = document.getElementById('registrationsList');
            
            if (currentRecordCount === 0) {
                emptyState.classList.remove('hidden');
                list.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                list.classList.remove('hidden');
            }
        }

        // Initialize on page load
        initializeDataSdk();
        generatePaymentQR(defaultConfig.upi_id, defaultConfig.entry_fee);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b202c3f3142637b',t:'MTc2NjQxMjMxNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>

</html>

